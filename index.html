<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telethone 2025 Live Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom CSS for top 3 rows highlight animation */
        .highlight-pulse {
            animation: pulse-ring 0.6s cubic-bezier(0, 0, 0.2, 1) forwards;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.4);
            }
            100% {
                transform: scale(1.02);
                box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
            }
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="root"></div>

    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Standalone to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const DEFAULT_SHEET_CONFIGS = {
            "Ibtidaiya": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Ibtidaiya" },
            "Sale Awwal": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sale Awwal" },
            "Sale Duwam": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sale Duwam" },
            "Ula": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Ula" },
            "Saniya": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Saniya" },
            "Salisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Salisa" },
            "Rabia": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Rabia" },
            "Khamisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Khamisa" },
            "Sadisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sadisa" },
            "Sabia": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sabia" },
            "Doratul Hadis": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Daurul Hadis" },
            "Takhassusat": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Takhassusat" },
        };

        const POLL_INTERVAL_MS = 5000;
        const LOCALSTORAGE_KEY = "telethone_sheet_overrides_enhanced_live";

        function parseSheetIdFromUrl(input) {
            if (!input) return null;
            input = input.trim();
            const m = input.match(/\/d\/([a-zA-Z0-9-_]{10,})/);
            if (m) return m[1];
            const m2 = input.match(/\/spreadsheets\/d\/e?\/(?:pubhtml\/)?([a-zA-Z0-9-_]{10,})/);
            if (m2) return m2[1];
            if (/^[a-zA-Z0-9-_]{10,}$/.test(input)) return input;
            return null;
        }

        function isValidSheetId(id) {
            return Boolean(id && /^[a-zA-Z0-9-_]{10,}$/.test(id));
        }

        function gvizUrl(sheetId, sheetName) {
            return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        }

        async function fetchSheetData(sheetId, sheetName) {
            const url = gvizUrl(sheetId, sheetName);
            const res = await fetch(url, { cache: "no-cache" });
            if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
            const text = await res.text();

            let jsonText = null;
            const match = text.match(/setResponse\(([\s\S]*)\);?\s*$/);
            if (match && match[1]) jsonText = match[1];
            else {
                const first = text.indexOf('{');
                const last = text.lastIndexOf('}');
                if (first !== -1 && last !== -1 && last > first) jsonText = text.slice(first, last + 1);
            }

            if (!jsonText) throw new Error('Could not extract JSON from GViz response; sheet may not be published or allowed.');

            let data;
            try {
                data = JSON.parse(jsonText);
            } catch (err) {
                throw new Error('Failed to parse GViz JSON — ' + err.message);
            }

            const cols = (data.table.cols || []).map((c, i) => (c.label || c.id || `col${i}`).toString());
            const rows = (data.table.rows || []).map((r) => r.c.map((cell) => (cell ? (cell.f !== undefined ? cell.f : cell.v) : null)));
            const items = rows.map((r) => {
                const obj = {};
                cols.forEach((k, i) => (obj[k || `col${i}`] = r[i]));
                return obj;
            });
            return { cols, items };
        }

        const RANK_CANDIDATES = ["Rank", "S. R.", "S.R.", "S R", "Sr", "Serial", "S No", "S.No"];
        // Updated to include "Class" as a candidate for the Ustaz Name column
        const USTAZ_CANDIDATES = ["Ustaz Name", "USTAZ NAME", "Ustaz", "Ustad", "Instructor", "Teacher", "Class"];
        const JAMIA_CANDIDATES = ["Jamia Name", "JAMIA NAME", "Jamia", "Jamiah"];
        const RAQAM_CANDIDATES = ["Raqam", "RAQAM", "Amount", "Value", "रकम", "राशि"];
        const UNIT_CANDIDATES = ["Unit", "UNIT", "Units"];

        function findColumnByCandidates(cols, candidates) {
            const lower = cols.map((c) => (c || "").toLowerCase().trim());
            for (let cand of candidates) {
                const target = cand.toLowerCase().trim();
                const idx = lower.findIndex((c) => c === target);
                if (idx >= 0) return cols[idx];
            }
            for (let cand of candidates) {
                const token = cand.toLowerCase().trim();
                const idx = lower.findIndex((c) => c.includes(token));
                if (idx >= 0) return cols[idx];
            }
            return null;
        }

        function medalForIndex(i) {
            if (i === 0) return "🥇";
            if (i === 1) return "🥈";
            if (i === 2) return "🥉";
            return "";
        }

        function TelethoneEnhancedLive() {
            const options = Object.keys(DEFAULT_SHEET_CONFIGS);
            const [active, setActive] = useState(options[0]);

            const [overrides, setOverrides] = useState(() => {
                try {
                    const raw = localStorage.getItem(LOCALSTORAGE_KEY);
                    if (raw) return JSON.parse(raw);
                } catch (e) {}
                const out = {};
                for (let k of Object.keys(DEFAULT_SHEET_CONFIGS)) if (DEFAULT_SHEET_CONFIGS[k].id) out[k] = DEFAULT_SHEET_CONFIGS[k].id;
                return out;
            });

            useEffect(() => {
                try {
                    localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(overrides));
                } catch (e) {}
            }, [overrides]);

            const [data, setData] = useState({ items: [] });
            const [isLoading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [sheetInput, setSheetInput] = useState("");
            const [highlightKey, setHighlightKey] = useState(null);
            const pollRef = useRef(null);

            function getActiveConfig() {
                const cfg = DEFAULT_SHEET_CONFIGS[active] || { id: "", sheet: "Sheet1" };
                const id = overrides[active] ?? cfg.id ?? "";
                return { id, sheet: cfg.sheet || "Sheet1" };
            }

            async function loadActiveSheet() {
                const { id, sheet } = getActiveConfig();
                if (!isValidSheetId(id)) {
                    setData({ items: [] });
                    setError(null);
                    setLoading(false);
                    return;
                }

                setLoading(true);
                setError(null);
                try {
                    const fetched = await fetchSheetData(id, sheet);
                    const cols = fetched.cols;
                    const rows = fetched.items;

                    const rankCol = findColumnByCandidates(cols, RANK_CANDIDATES);
                    const ustazCol = findColumnByCandidates(cols, USTAZ_CANDIDATES);
                    const jamiaCol = findColumnByCandidates(cols, JAMIA_CANDIDATES);
                    const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);
                    const unitCol = findColumnByCandidates(cols, UNIT_CANDIDATES);

                    if (!jamiaCol || !raqamCol) {
                        setError("Sheet must contain at least 'Jamia Name' and 'Raqam' headers in the first row. Ensure header row exists and is readable.");
                        setData({ items: [] });
                        setLoading(false);
                        return;
                    }

                    const parsed = rows
                        .map((r, idx) => {
                            const rankRaw = rankCol ? r[rankCol] : null;
                            const ustazRaw = ustazCol ? r[ustazCol] : null;
                            const jamiaRaw = r[jamiaCol];
                            const raqamRaw = r[raqamCol];
                            const unitRaw = unitCol ? r[unitCol] : null;

                            const rank = rankRaw === null || rankRaw === undefined ? "" : String(rankRaw).trim();
                            const ustaz = ustazRaw === null || ustazRaw === undefined ? "" : String(ustazRaw).trim();
                            const jamia = jamiaRaw === null || jamiaRaw === undefined ? "" : String(jamiaRaw).trim();
                            const unit = unitRaw === null || unitRaw === undefined ? "" : String(unitRaw).trim();

                            const n = raqamRaw === null || raqamRaw === undefined || String(raqamRaw).trim() === "" ? NaN : Number(String(raqamRaw).replace(/[^0-9.-]+/g, ""));

                            return { __id: idx, rank, ustaz, jamia, unit, raqamRaw, __value: Number.isNaN(n) ? NaN : n };
                        })
                        .filter((x) => x.jamia !== "" && !Number.isNaN(x.__value));

                    parsed.sort((a, b) => b.__value - a.__value);

                    const newTop = parsed.length ? parsed[0].__id : null;
                    if (newTop !== null && newTop !== highlightKey) {
                        setHighlightKey(parsed[0].__id);
                        setTimeout(() => setHighlightKey(null), 1200);
                    }

                    setData({ items: parsed });
                    setLoading(false);
                } catch (err) {
                    console.error(err);
                    setError(err.message || String(err));
                    setData({ items: [] });
                    setLoading(false);
                }
            }

            useEffect(() => {
                if (pollRef.current) clearInterval(pollRef.current);
                const { id } = getActiveConfig();
                if (isValidSheetId(id)) {
                    loadActiveSheet();
                    pollRef.current = setInterval(loadActiveSheet, POLL_INTERVAL_MS);
                } else {
                    setData({ items: [] });
                    setError(null);
                }
                return () => clearInterval(pollRef.current);
                // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [active, overrides[active]]);

            function handleSetSheetId(e) {
                e.preventDefault();
                const possible = parseSheetIdFromUrl(sheetInput);
                if (!possible) {
                    setError("Could not extract a valid Sheet ID from the input. Paste a full sheet URL or the sheet ID.");
                    return;
                }
                setOverrides((prev) => ({ ...prev, [active]: possible }));
                setSheetInput("");
                setError(null);
            }
            
            const ustazLabel = active === 'Takhassusat' ? 'Class' : 'Ustaz Name';

            return (
                <div className="min-h-screen bg-gray-50 p-6 rounded-2xl">
                    <div className="max-w-7xl mx-auto">
                        <header className="mb-6">
                            <h1 className="text-4xl font-extrabold text-slate-800">Telethone 2025</h1>
                            <p className="text-sm text-slate-500 mt-1">Jamia-tul-Madina India Class Wise Positions</p>
                        </header>

                        <nav className="mb-4">
                            {/* Desktop Navigation */}
                            <div className="hidden md:flex flex-wrap gap-2">
                                {options.map((opt) => {
                                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                                    const id = overrides[opt] ?? cfg.id ?? "";
                                    const valid = isValidSheetId(id);
                                    return (
                                        <button
                                            key={opt}
                                            onClick={() => setActive(opt)}
                                            className={`px-3 py-2 rounded-2xl font-medium text-sm shadow-sm focus:outline-none transition-transform transform hover:-translate-y-0.5 ${
                                                active === opt ? "bg-sky-600 text-white shadow-lg" : "bg-white text-slate-700 border border-slate-200"
                                            }`}
                                            title={valid ? `Sheet configured (${id.slice(0, 8)}...)` : "Not configured — click and paste sheet URL/ID"}
                                        >
                                            <span className="inline-flex items-center gap-2">
                                                <span className={`w-2 h-2 rounded-full ${valid ? "bg-emerald-400" : "bg-rose-400"}`} />
                                                <span>{opt}</span>
                                            </span>
                                        </button>
                                    );
                                })}
                            </div>

                            {/* Mobile Dropdown */}
                            <div className="md:hidden">
                                <label htmlFor="class-select" className="sr-only">Select a Class</label>
                                <select
                                    id="class-select"
                                    value={active}
                                    onChange={(e) => setActive(e.target.value)}
                                    className="block w-full px-3 py-2 rounded-lg bg-white border border-slate-300 text-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                                >
                                    {options.map((opt) => (
                                        <option key={opt} value={opt}>{opt}</option>
                                    ))}
                                </select>
                            </div>
                        </nav>
                        
                        <div className="flex flex-col items-center justify-center p-4 bg-purple-200 rounded-lg shadow-md mb-4">
                            <h2 className="text-xl font-bold text-purple-800 text-center">{active}</h2>
                        </div>

                        <main>
                            <div className="bg-white border rounded-lg overflow-hidden p-4">
                                {(!isValidSheetId(getActiveConfig().id)) && (
                                    <div className="mb-4">
                                        <div className="text-sm text-slate-700 mb-2">This option does not have a sheet configured. Paste the Google Sheet URL or Sheet ID below to enable live fetching.</div>
                                        <form onSubmit={handleSetSheetId} className="flex gap-2">
                                            <input
                                                value={sheetInput}
                                                onChange={(e) => setSheetInput(e.target.value)}
                                                placeholder="Paste full Google Sheet URL or sheet ID"
                                                className="flex-1 px-3 py-2 border rounded-lg"
                                            />
                                            <button type="submit" className="px-4 py-2 rounded-lg bg-sky-600 text-white">Set</button>
                                        </form>
                                        <div className="text-xs text-slate-500 mt-2">Tip: Use the sheet's share link (or the /d/{id}/ URL). If you see permission errors, try File → Publish to web in Google Sheets.</div>
                                        {error && <div className="text-sm text-rose-600 mt-2">Error: {error}</div>}
                                    </div>
                                )}

                                {isLoading && <div className="text-sm text-slate-600 mb-2">Loading…</div>}
                                {error && isValidSheetId(getActiveConfig().id) && <div className="text-sm text-rose-600 mb-2">Fetch error: {error}</div>}

                                {/* Desktop Table */}
                                <div className="hidden md:block">
                                    {/* Header row */}
                                    <div className="grid grid-cols-12 items-center px-3 py-2 border-b text-sm font-semibold text-slate-700">
                                        <div className="col-span-1">Rank</div>
                                        <div className="col-span-2">{ustazLabel}</div>
                                        <div className="col-span-6 text-center">Jamia Name</div>
                                        <div className="col-span-2 text-right">Raqam</div>
                                        <div className="col-span-1 text-right">Unit</div>
                                    </div>

                                    {/* Items */}
                                    <div className="space-y-3 mt-3">
                                        {data.items.map((it, idx) => {
                                            const isTop = idx === 0;
                                            const isSecond = idx === 1;
                                            const isThird = idx === 2;
                                            const medal = medalForIndex(idx);
                                            const highlight = it.__id === highlightKey;

                                            const styleClass = isTop
                                                ? "bg-yellow-50 border border-yellow-200"
                                                : isSecond
                                                ? "bg-sky-50 border border-sky-200"
                                                : isThird
                                                ? "bg-emerald-50 border border-emerald-200"
                                                : "bg-white border-transparent";

                                            return (
                                                <div key={it.__id} className={`grid grid-cols-12 items-center gap-4 p-3 rounded-lg transition-all duration-600 transform ${styleClass} ${highlight ? "highlight-pulse" : ""}`} style={{ willChange: "transform, box-shadow" }}>
                                                    <div className="col-span-1 flex items-center justify-center font-bold text-base">{idx + 1}</div>

                                                    <div className={`col-span-2 text-left ${isTop || isSecond || isThird ? "text-base font-semibold" : "text-sm font-medium"}`}>
                                                        {it.ustaz || "-"}
                                                    </div>

                                                    <div className={`col-span-6 text-center ${isTop ? "text-xl font-extrabold" : isSecond ? "text-lg font-bold" : isThird ? "text-lg font-semibold" : "text-base font-medium"}`}>
                                                        <span className="inline-flex items-center gap-2">{medal}<span>{it.jamia}</span></span>
                                                    </div>

                                                    <div className={`col-span-2 text-right ${isTop ? "text-xl font-extrabold" : "text-base font-semibold"}`}>
                                                        {it.__value.toLocaleString()}
                                                    </div>

                                                    <div className="col-span-1 text-right text-sm">{it.unit || "-"}</div>
                                                </div>
                                            );
                                        })}

                                        {(!data.items || data.items.length === 0) && <div className="text-sm text-slate-500 p-3">No valid rows found (ensure Jamia Name and Raqam columns exist and Raqam values are numeric).</div>}
                                    </div>
                                </div>

                                {/* Mobile List View */}
                                <div className="md:hidden space-y-4">
                                    {data.items.map((it, idx) => {
                                        const isTop = idx === 0;
                                        const isSecond = idx === 1;
                                        const isThird = idx === 2;
                                        const medal = medalForIndex(idx);
                                        const highlight = it.__id === highlightKey;
                                        const styleClass = isTop
                                                ? "bg-yellow-50 border border-yellow-200"
                                                : isSecond
                                                ? "bg-sky-50 border border-sky-200"
                                                : isThird
                                                ? "bg-emerald-50 border border-emerald-200"
                                                : "bg-white border-transparent";
                                        
                                        return (
                                            <div key={it.__id} className={`p-4 rounded-lg shadow-sm transition-all duration-600 transform ${styleClass} ${highlight ? "highlight-pulse" : ""}`} style={{ willChange: "transform, box-shadow" }}>
                                                <div className="flex items-center justify-between">
                                                    <div className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                                        <span>{idx + 1}.</span>
                                                        <span>{it.jamia}</span>
                                                        <span>{medal}</span>
                                                    </div>
                                                    <div className={`text-xl font-bold text-right ${isTop ? "text-green-600" : "text-slate-700"}`}>
                                                        {it.__value.toLocaleString()}
                                                    </div>
                                                </div>
                                                <div className="mt-2 text-sm text-slate-600 flex justify-between">
                                                    <div><span className="font-semibold">{ustazLabel}:</span> {it.ustaz || "-"}</div>
                                                    <div><span className="font-semibold">Unit:</span> {it.unit || "-"}</div>
                                                </div>
                                            </div>
                                        );
                                    })}

                                    {(!data.items || data.items.length === 0) && <div className="text-sm text-slate-500 p-3">No valid rows found (ensure Jamia Name and Raqam columns exist and Raqam values are numeric).</div>}
                                </div>
                            </div>
                        </main>

                        <footer className="mt-8 text-xs text-slate-500">Made with ❤️ — Majlis Talimi Umoor India</footer>
                    </div>
                </div>
            );
        }

        // Render the React component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <React.StrictMode>
                <TelethoneEnhancedLive />
            </React.StrictMode>
        );
    </script>

</body>
</html>
