<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telethone 2025 Live Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bowlby+One+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        /* Custom CSS for top 3 rows highlight animation */
        .highlight-pulse {
            animation: pulse-ring 0.6s cubic-bezier(0, 0, 0.2, 1) forwards;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.4);
            }
            100% {
                transform: scale(1.02);
                box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
            }
        }

        /* Custom CSS for Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Blue 500 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* NEW: Custom CSS for smooth transitions on rank items */
        .rank-item {
            /* Smooth transition for position changes */
            transition: all 0.5s ease-in-out;
            will-change: transform, box-shadow;
        }
        /* Hide loading when data is already present (removed from logic, but keeping style for other tabs) */
        .loading-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.6);
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="root"></div>

    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- Utility Functions for Formatting and Animation ---

        // Formatter for Currency
        const formatCurrency = (amount) => {
            // Round to nearest integer for clean animation and display
            return '₹ ' + new Intl.NumberFormat('en-IN').format(Math.round(amount));
        };

        // Formatter for Unit (Used for individual class units, not Overall Rank)
        const formatUnit = (unit) => {
            return new Intl.NumberFormat('en-IN').format(Math.round(unit));
        };
        
        // Formatter for Overall Rank Units (Amount / 7000, fixed to 1 decimal place)
        const formatOverallUnit = (amount) => {
             if (typeof amount !== 'number' || amount < 0) return "0.0";
             const units = amount / 7000;
             return units.toFixed(1); // Show exactly 1 decimal place
        }


        // Component for smooth number animation (Kept for other total numbers if needed, but not used in Overall Rank now)
        const AnimatedNumber = ({ value, duration = 1500, formatter }) => {
            const [displayValue, setDisplayValue] = useState(value);
            const previousValueRef = useRef(value);

            useEffect(() => {
                let startTimestamp;
                const startValue = previousValueRef.current || 0;
                const endValue = value || 0;
                
                // If value hasn't changed or component is new and value is 0, skip animation
                if (endValue === startValue) {
                    setDisplayValue(endValue);
                    return;
                }

                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const elapsed = timestamp - startTimestamp;
                    const progress = Math.min(1, elapsed / duration);

                    // Easing function (simple cubic ease-out)
                    const easedProgress = 1 - Math.pow(1 - progress, 3); 

                    const currentValue = startValue + (endValue - startValue) * easedProgress;
                    setDisplayValue(currentValue);

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        setDisplayValue(endValue); 
                    }
                };

                const animationFrameId = requestAnimationFrame(step);

                // Cleanup function
                return () => {
                    cancelAnimationFrame(animationFrameId);
                    // Update previous value for the next render cycle
                    previousValueRef.current = endValue; 
                };
            }, [value, duration]);

            // Update ref for immediate re-render on value change if component re-mounts
            useEffect(() => {
                previousValueRef.current = value;
            }, [value]);


            return <span>{formatter(displayValue)}</span>;
        };
        
        // --- Google Sheet Configuration and Logic (Original) ---
        
        const DEFAULT_SHEET_CONFIGS = {
            "Ibtidaiya": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Ibtidaiya" },
            "Sale Awwal": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sale Awwal" },
            "Sale Duwam": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sale Duwam" },
            "Ula": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Ula" },
            "Saniya": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Saniya" },
            "Salisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Salisa" },
            "Rabia": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Rabia" },
            "Khamisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Khamisa" },
            "Sadisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sadisa" },
            "Sabia": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sabia" },
            "Doratul Hadis": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Daurul Hadis" },
            "Takhassusat": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Takhassusat" },
            // Overall Rank and Result tabs are special cases
            "Overall Rank": { id: null, sheet: null },
            "Result": { id: null, sheet: null }
        };

        const POLL_INTERVAL_MS = 5000;
        const LOCALSTORAGE_KEY = "telethone_sheet_overrides_enhanced_live";
        const UNIT_DIVISOR = 7000; // New constant for unit calculation

        // Utility function to extract the Google Sheet ID from various URLs or raw input
        function parseSheetIdFromUrl(input) {
            if (!input) return null;
            input = input.trim();
            const m = input.match(/\/d\/([a-zA-Z0-9-_]{10,})/);
            if (m) return m[1];
            const m2 = input.match(/\/spreadsheets\/d\/e?\/(?:pubhtml\/)?([a-zA-Z0-9-_]{10,})/);
            if (m2) return m2[1];
            if (/^[a-zA-Z0-9-_]{10,}$/.test(input)) return input;
            return null;
        }

        // Utility function to validate the extracted Sheet ID
        function isValidSheetId(id) {
            return Boolean(id && /^[a-zA-Z0-9-_]{10,}$/.test(id));
        }

        // Constructs the Google Visualization API URL
        function gvizUrl(sheetId, sheetName) {
            return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        }

        // Fetches and parses data from the Google Sheet via GViz API
        async function fetchSheetData(sheetId, sheetName) {
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const url = gvizUrl(sheetId, sheetName);
                    const res = await fetch(url, { cache: "no-cache" });
                    
                    if (res.status === 429) { 
                        if (attempt < 2) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error("Too many requests to Google Sheets API.");
                    }

                    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
                    const text = await res.text();

                    let jsonText = null;
                    const match = text.match(/setResponse\(([\s\S]*)\);?\s*$/);
                    if (match && match[1]) jsonText = match[1];
                    else {
                        const first = text.indexOf('{');
                        const last = text.lastIndexOf('}');
                        if (first !== -1 && last !== -1 && last > first) jsonText = text.slice(first, last + 1);
                    }

                    if (!jsonText) throw new Error('Could not extract JSON from GViz response; sheet may not be published or allowed.');

                    let data;
                    try {
                        data = JSON.parse(jsonText);
                    } catch (err) {
                        throw new Error('Failed to parse GViz JSON — ' + err.message);
                    }

                    const cols = (data.table.cols || []).map((c, i) => (c.label || c.id || `col${i}`).toString());
                    const rows = (data.table.rows || []).map((r) => r.c.map((cell) => (cell ? (cell.f !== undefined ? cell.f : cell.v) : null)));
                    const items = rows.map((r) => {
                        const obj = {};
                        cols.forEach((k, i) => (obj[k || `col${i}`] = r[i]));
                        return obj;
                    });
                    return { cols, items };

                } catch (error) {
                    if (attempt === 2) throw error;
                    if (error.message.includes("Too many requests")) throw error;
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Failed to fetch sheet data after multiple retries.");
        }


        // Candidate headers for automatic column mapping
        const RANK_CANDIDATES = ["Rank", "S. R.", "S.R.", "S R", "Sr", "Serial", "S No", "S.No"];
        const USTAZ_CANDIDATES = ["Ustaz Name", "USTAZ NAME", "Ustaz", "Ustad", "Instructor", "Teacher", "Class"];
        const JAMIA_CANDIDATES = ["Jamia Name", "JAMIA NAME", "Jamia", "Jamiah"];
        const RAQAM_CANDIDATES = ["Raqam", "RAQAM", "Amount", "Value", "रकम", "राशि"];
        const UNIT_CANDIDATES = ["Unit", "UNIT", "Units"];

        // Finds the correct column header based on a list of candidates
        function findColumnByCandidates(cols, candidates) {
            const lower = cols.map((c) => (c || "").toLowerCase().trim());
            for (let cand of candidates) {
                const target = cand.toLowerCase().trim();
                const idx = lower.findIndex((c) => c === target);
                if (idx >= 0) return cols[idx];
            }
            for (let cand of candidates) {
                const token = cand.toLowerCase().trim();
                const idx = lower.findIndex((c) => c.includes(token));
                if (idx >= 0) return cols[idx];
            }
            return null;
        }

        // Returns a medal emoji for the top 3 ranks
        function medalForIndex(i) {
            if (i === 0) return "🥇";
            if (i === 1) return "🥈";
            if (i === 2) return "🥉";
            return "";
        }
        
        // Countdown Logic
        function calculateTimeRemaining(targetDate) {
            const now = new Date();
            const difference = targetDate - now;

            if (difference <= 0) {
                return { days: 0, hours: 0, minutes: 0, seconds: 0, expired: true };
            }

            const seconds = Math.floor((difference / 1000) % 60);
            const minutes = Math.floor((difference / 1000 / 60) % 60);
            const hours = Math.floor((difference / (1000 * 60 * 60)) % 24);
            const days = Math.floor(difference / (1000 * 60 * 60 * 24));

            return { days, hours, minutes, seconds, expired: false };
        }
        
        // Function to safely parse a string to a number
        function parseNumericValue(value, isInteger = false) {
            if (value === null || value === undefined || String(value).trim() === "") {
                return NaN;
            }
            const cleaned = String(value).replace(/[^0-9.-]+/g, "");
            const n = Number(cleaned);
            
            if (Number.isNaN(n)) return NaN;
            
            return isInteger ? Math.round(n) : n;
        }


        function TelethoneEnhancedLive() {
            const options = Object.keys(DEFAULT_SHEET_CONFIGS);
            const [active, setActive] = useState("Ibtidaiya"); // Changed default to a class

            // State to handle user-defined sheet ID overrides
            const [overrides, setOverrides] = useState(() => {
                try {
                    const raw = localStorage.getItem(LOCALSTORAGE_KEY);
                    if (raw) return JSON.parse(raw);
                } catch (e) {}
                const out = {};
                for (let k of Object.keys(DEFAULT_SHEET_CONFIGS)) if (DEFAULT_SHEET_CONFIGS[k].id) out[k] = DEFAULT_SHEET_CONFIGS[k].id;
                return out;
            });

            // Persist overrides to localStorage
            useEffect(() => {
                try {
                    localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(overrides));
                } catch (e) {}
            }, [overrides]);

            // Main dashboard data states
            const [data, setData] = useState({ items: [] });
            const [isLoading, setLoading] = useState(true); 
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [error, setError] = useState(null);
            const [sheetInput, setSheetInput] = useState("");
            const [highlightKey, setHighlightKey] = useState(null);
            const pollRef = useRef(null);
            
            // Countdown state and result data
            const targetDate = new Date('September 28, 2025 21:30:00 GMT+0530');
            const [countdown, setCountdown] = useState(calculateTimeRemaining(targetDate));
            const [resultData, setResultData] = useState({});
            const [isResultLoading, setResultLoading] = useState(false);
            const [resultError, setResultError] = useState(null);

            // NEW: Overall Rank States
            const [overallRankData, setOverallRankData] = useState([]);
            // State for the big animated numbers (Kept, but not rendered)
            const [overallTotalAmount, setOverallTotalAmount] = useState(0); 
            const [overallTotalUnit, setOverallTotalUnit] = useState(0);
            
            const [isRankLoading, setRankLoading] = useState(true);
            const [isRankDataLoaded, setIsRankDataLoaded] = useState(false);
            const [rankError, setRankError] = useState(null);


            // Gets the Sheet ID and sheet name for the active tab
            function getActiveConfig() {
                const cfg = DEFAULT_SHEET_CONFIGS[active] || { id: "", sheet: "Sheet1" };
                const id = overrides[active] ?? cfg.id ?? "";
                return { id, sheet: cfg.sheet || "Sheet1" };
            }

            // Function to fetch and process data for the active sheet (Individual Class)
            async function loadActiveSheet() {
                const { id, sheet } = getActiveConfig();
                
                if (!isValidSheetId(id)) {
                    setData({ items: [] });
                    setError(null);
                    setLoading(false);
                    return;
                }

                if (!isDataLoaded) setLoading(true); 
                setError(null);
                try {
                    const fetched = await fetchSheetData(id, sheet);
                    const cols = fetched.cols;
                    const rows = fetched.items;

                    const rankCol = findColumnByCandidates(cols, RANK_CANDIDATES);
                    const ustazCol = findColumnByCandidates(cols, USTAZ_CANDIDATES);
                    const jamiaCol = findColumnByCandidates(cols, JAMIA_CANDIDATES);
                    const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);
                    const unitCol = findColumnByCandidates(cols, UNIT_CANDIDATES);

                    if (!jamiaCol || !raqamCol) {
                        setError("Sheet mein kam-az-kam 'Jamia Name' aur 'Raqam' ke headers pehli row mein hone chahiye. Confirm karein ki header row maujood hai aur padhni ja sakti hai.");
                        setData({ items: [] });
                        setLoading(false);
                        setIsDataLoaded(true);
                        return;
                    }

                    const parsed = rows
                        .map((r, idx) => {
                            const rankRaw = rankCol ? r[rankCol] : null;
                            const ustazRaw = ustazCol ? r[ustazCol] : null;
                            const jamiaRaw = r[jamiaCol];
                            const raqamRaw = r[raqamCol];
                            const unitRaw = unitCol ? r[unitCol] : null;

                            const rank = rankRaw === null || rankRaw === undefined ? "" : String(rankRaw).trim();
                            const ustaz = ustazRaw === null || ustazRaw === undefined ? "" : String(ustazRaw).trim();
                            const jamia = jamiaRaw === null || jamiaRaw === undefined ? "" : String(jamiaRaw).trim();
                            
                            const unit = parseNumericValue(unitRaw, true); 
                            const n = parseNumericValue(raqamRaw);

                            return { __id: idx, rank, ustaz, jamia, unit: Number.isNaN(unit) ? "" : unit, raqamRaw, __value: n };
                        })
                        .filter((x) => x.jamia !== "" && !Number.isNaN(x.__value));

                    parsed.sort((a, b) => b.__value - a.__value);
                    
                    const newTopId = parsed.length ? parsed[0].__id : null;
                    if (newTopId !== null && newTopId !== highlightKey) {
                        setHighlightKey(newTopId);
                        setTimeout(() => setHighlightKey(null), 1200);
                    }

                    setData({ items: parsed });
                    setLoading(false);
                    setIsDataLoaded(true);
                } catch (err) {
                    console.error(err);
                    setError(err.message || String(err));
                    if (!isDataLoaded) setData({ items: [] }); 
                    setLoading(false);
                    setIsDataLoaded(true);
                }
            }

            // Function to load all class totals for overall ranking
            async function loadOverallRank() {
                // Only show loading indicator on the first load for overall rank
                if (!isRankDataLoaded) setRankLoading(true);
                setRankError(null);
                const sheetOptions = options.filter(key => key !== "Result" && key !== "Overall Rank");
                
                const fetchPromises = sheetOptions.map(async (opt) => {
                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                    const id = overrides[opt] ?? cfg.id ?? "";
                    
                    if (!isValidSheetId(id)) {
                        // For overall rank calculation, if a sheet is not configured, its contribution is 0
                        return { className: opt, totalAmount: 0, totalUnit: 0, error: "Not Configured" };
                    }

                    try {
                        const fetched = await fetchSheetData(id, cfg.sheet);
                        const cols = fetched.cols;
                        const rows = fetched.items;

                        const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);
                        const unitCol = findColumnByCandidates(cols, UNIT_CANDIDATES);

                        if (!raqamCol) {
                            return { className: opt, totalAmount: 0, totalUnit: 0, error: "Missing Raqam Column" };
                        }
                        
                        let totalAmount = 0;
                        let totalUnit = 0; // This is not used now, as unit is calculated from amount

                        rows.forEach((r) => {
                            const raqamRaw = r[raqamCol];
                            // const unitRaw = unitCol ? r[unitCol] : null; // Original unit column is ignored now

                            const n = parseNumericValue(raqamRaw);
                            // const u = parseNumericValue(unitRaw, true); // Original unit value is ignored now

                            totalAmount += Number.isNaN(n) ? 0 : n;
                            // totalUnit += Number.isNaN(u) ? 0 : u; // Original unit calculation is ignored now
                        });
                        
                        // NEW LOGIC: Calculate unit based on amount
                        const calculatedUnit = totalAmount / UNIT_DIVISOR;
                        
                        return { className: opt, totalAmount, totalUnit: calculatedUnit, error: null };
                    } catch (err) {
                        console.error(`Error fetching data for ${opt}:`, err);
                        return { className: opt, totalAmount: 0, totalUnit: 0, error: err.message };
                    }
                });

                try {
                    const results = await Promise.all(fetchPromises);
                    
                    // Filter out rows where Total Amount is 0 AND Total Unit is 0 AND it's not a missing column error
                    const validResults = results.filter(r => r.totalAmount > 0 || r.totalUnit > 0 || (r.error && r.error.includes("Missing Raqam Column")));
                    
                    // Calculate grand totals for the animated numbers (kept for logic, but not rendered)
                    const grandTotalAmount = results.reduce((sum, r) => sum + r.totalAmount, 0);
                    const grandTotalUnit = results.reduce((sum, r) => sum + r.totalUnit, 0); // This total unit is now the sum of calculated units

                    setOverallTotalAmount(grandTotalAmount);
                    setOverallTotalUnit(grandTotalUnit);
                    
                    // Sort for the rank list
                    // Sort primarily by totalAmount, secondarily by calculated totalUnit
                    validResults.sort((a, b) => {
                        if (b.totalAmount !== a.totalAmount) {
                            return b.totalAmount - a.totalAmount;
                        }
                        return b.totalUnit - a.totalUnit;
                    });

                    setOverallRankData(validResults);
                    setRankLoading(false);
                    setIsRankDataLoaded(true);

                } catch (e) {
                    setRankError("Sabhi rank data ko process nahi kiya ja saka.");
                    setRankLoading(false);
                    setIsRankDataLoaded(true);
                }
            }


            // Function to load all class results for the "Result" tab 
            async function loadAllResults() {
                setResultLoading(true);
                setResultError(null);
                const allWinnersByClass = {};
                const sheetOptions = options.filter(key => key !== "Result" && key !== "Overall Rank");

                const fetchPromises = sheetOptions.map(async (opt) => {
                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                    const id = overrides[opt] ?? cfg.id ?? "";
                    
                    if (!isValidSheetId(id)) return { className: opt, winners: [], error: "Not Configured" };

                    try {
                        const fetched = await fetchSheetData(id, cfg.sheet);
                        const cols = fetched.cols;
                        const rows = fetched.items;

                        const jamiaCol = findColumnByCandidates(cols, JAMIA_CANDIDATES);
                        const ustazCol = findColumnByCandidates(cols, USTAZ_CANDIDATES);
                        const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);

                        if (!jamiaCol || !raqamCol) return { className: opt, winners: [], error: "Missing Columns" };

                        const parsed = rows
                            .map((r, idx) => {
                                const jamiaRaw = r[jamiaCol];
                                const ustazRaw = ustazCol ? r[ustazCol] : null;
                                const raqamRaw = r[raqamCol];

                                const ustaz = ustazRaw === null || ustazRaw === undefined ? "" : String(ustazRaw).trim();
                                const jamia = jamiaRaw === null || jamiaRaw === undefined ? "" : String(jamiaRaw).trim();
                                const n = parseNumericValue(raqamRaw);

                                return { __id: idx, ustaz, jamia, __value: n };
                            })
                            .filter((x) => x.jamia !== "" && !Number.isNaN(x.__value));

                        parsed.sort((a, b) => b.__value - a.__value);
                        
                        return { className: opt, winners: parsed.slice(0, 3) };
                    } catch (err) {
                        console.error(`Error fetching results for ${opt}:`, err);
                        return { className: opt, winners: [], error: err.message };
                    }
                });

                try {
                    const results = await Promise.all(fetchPromises);
                    const winnersMap = {};
                    results.forEach(r => {
                        if (r.winners && r.winners.length > 0) {
                             winnersMap[r.className] = r.winners;
                        } else if (r.error && r.error.includes("Too many requests")) {
                            setResultError(r.error);
                        }
                    });
                    setResultData(winnersMap);

                } catch (e) {
                    setResultError("Sabhi results data ko process nahi kiya ja saka.");
                } finally {
                    setResultLoading(false);
                }
            }

            // Main effect hook for polling and countdown updates
            useEffect(() => {
                if (active === "Result") {
                    if (pollRef.current) clearInterval(pollRef.current);
                    if (countdown.expired) {
                        loadAllResults();
                    }
                    const timer = setInterval(() => {
                        setCountdown(calculateTimeRemaining(targetDate));
                    }, 1000);
                    return () => clearInterval(timer);
                } else if (active === "Overall Rank") { 
                    if (pollRef.current) clearInterval(pollRef.current);
                    loadOverallRank();
                    // Poll silently in the background
                    pollRef.current = setInterval(loadOverallRank, POLL_INTERVAL_MS);
                    return () => clearInterval(pollRef.current);
                } else {
                    if (pollRef.current) clearInterval(pollRef.current);
                    const { id } = getActiveConfig();
                    if (isValidSheetId(id)) {
                        loadActiveSheet();
                        pollRef.current = setInterval(loadActiveSheet, POLL_INTERVAL_MS);
                    } else {
                        setData({ items: [] });
                        setError(null);
                        setLoading(false);
                        setIsDataLoaded(true);
                    }
                    return () => clearInterval(pollRef.current);
                }
            }, [active, overrides, countdown.expired]);

            // Handler to set the new sheet ID/URL
            function handleSetSheetId(e) {
                e.preventDefault();
                const possible = parseSheetIdFromUrl(sheetInput);
                if (!possible) {
                    setError("Input se koi valid Sheet ID nahi nikali ja saki. Barae Karam poora sheet URL ya sirf Sheet ID paste karein.");
                    return;
                }
                setOverrides((prev) => ({ ...prev, [active]: possible }));
                setSheetInput("");
                setError(null);
            }
            
            // Dynamic labels based on active tab
            const ustazLabel = active === 'Takhassusat' ? 'Jamia Name' : 'Ustaz Name';
            const jamiaLabel = active === 'Takhassusat' ? 'Class' : 'Jamia Name';

            // Check if full screen loader should be active (only on first load)
            // For Overall Rank, we only want the loader on initial load (!isRankDataLoaded)
            const showFullScreenLoader = (active !== "Overall Rank" && isLoading && !isDataLoaded) || 
                                         (active === "Overall Rank" && isRankLoading && !isRankDataLoaded);

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="max-w-7xl mx-auto p-4 sm:p-6">
                        <header className="mb-6 text-center">
                            <h1 className="text-6xl sm:text-7xl font-['Bebas_Neue'] bg-clip-text text-transparent bg-gradient-to-r from-sky-500 to-indigo-600">
                                TELETHONE 2025
                            </h1>
                            <p className="text-sm text-slate-500 mt-1">Jamia-tul-Madina India Class/Jamia Wise Positions</p>
                        </header>

                        <nav className="mb-4">
                            {/* Desktop Navigation */}
                            <div className="hidden md:flex flex-wrap gap-2 justify-center">
                                {options.map((opt) => {
                                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                                    const id = overrides[opt] ?? cfg.id ?? "";
                                    const valid = isValidSheetId(id) || opt === "Overall Rank" || opt === "Result"; 
                                    return (
                                        <button
                                            key={opt}
                                            onClick={() => {
                                                setActive(opt);
                                                if (overrides[opt]) setSheetInput(overrides[opt]);
                                            }}
                                            className={`px-3 py-2 rounded-2xl font-medium text-sm shadow-sm focus:outline-none transition-transform transform hover:-translate-y-0.5 ${
                                                active === opt ? "bg-sky-600 text-white shadow-lg" : "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50"
                                            }`}
                                            title={opt !== "Overall Rank" && opt !== "Result" ? (valid ? `Sheet configured (${id.slice(0, 8)}...)` : "Not configured — click and paste sheet URL/ID") : opt}
                                        >
                                            <span className="inline-flex items-center gap-2">
                                                {opt !== "Overall Rank" && opt !== "Result" && <span className={`w-2 h-2 rounded-full ${valid ? "bg-emerald-400" : "bg-rose-400"}`} />}
                                                <span>{opt}</span>
                                            </span>
                                        </button>
                                    );
                                })}
                            </div>

                            {/* Mobile Dropdown */}
                            <div className="md:hidden">
                                <label htmlFor="class-select" className="sr-only">Select a Class</label>
                                <select
                                    id="class-select"
                                    value={active}
                                    onChange={(e) => setActive(e.target.value)}
                                    className="block w-full px-3 py-2 rounded-lg bg-white border border-slate-300 text-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 shadow-sm"
                                >
                                    {options.map((opt) => (
                                        <option key={opt} value={opt}>{opt}</option>
                                    ))}
                                </select>
                            </div>
                        </nav>
                        
                        <div className="flex flex-col items-center justify-center p-3 bg-indigo-50 rounded-xl shadow-md mb-4 border border-indigo-200">
                            <h2 className="text-2xl font-['Bowlby_One_SC'] text-indigo-900 text-center uppercase">{active}</h2>
                        </div>

                        <main className="relative">
                            {/* Full Screen Initial Loader (Runs only on first load for Overall Rank) */}
                            {showFullScreenLoader && (
                                <div className="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex justify-center items-center rounded-lg shadow-xl">
                                    <div className="text-xl text-slate-500 flex flex-col items-center p-8 bg-white border rounded-xl shadow-lg">
                                        <div className="loader w-10 h-10 mb-4 border-t-sky-500 border-4"></div>
                                        {active === "Overall Rank" ? "Overall Ranking Load ho raha hai..." : "Live Data Load ho raha hai..."}
                                    </div>
                                </div>
                            )}

                            {active === "Overall Rank" ? (
                                /* --- Overall Rank Tab View --- */
                                <div className="bg-white border rounded-lg p-4 shadow-lg relative">
                                    {/* Grand Totals Section has been removed as requested. */}
                                    
                                    <h2 className="text-xl md:text-2xl font-bold text-slate-800 mb-4 text-center border-b pb-2">All India Class Wise Rank</h2>
                                    
                                    {/* Background Loader for updates has been removed as requested. 
                                        Data is now fetched silently in the background. */}
                                    
                                    {rankError && <div className="text-sm text-rose-600 mb-4 p-2 border border-rose-300 bg-rose-50 rounded-lg">Error: {rankError}</div>}

                                    {/* Desktop Header */}
                                    <div className="hidden md:grid grid-cols-12 items-center px-3 py-2 border-b text-sm font-semibold text-slate-700 bg-slate-50 rounded-t-lg">
                                        <div className="col-span-1">Rank</div>
                                        <div className="col-span-5">Class Name</div>
                                        <div className="col-span-3 text-center">Calculated Unit</div>
                                        <div className="col-span-3 text-right">Total Amount</div>
                                    </div>

                                    {/* Overall Rank List */}
                                    <div className="space-y-3 mt-1">
                                        {overallRankData.map((item, idx) => {
                                            const isTop = idx === 0;
                                            const medal = medalForIndex(idx);
                                            
                                            // Format the calculated unit to 1 decimal place
                                            const formattedUnit = formatOverallUnit(item.totalAmount);
                                            
                                            return (
                                                <div 
                                                    key={item.className} 
                                                    className={`rank-item grid grid-cols-12 items-center p-3 md:p-4 rounded-xl shadow-sm border 
                                                        ${isTop ? "bg-yellow-50 border-yellow-400 shadow-lg" : "bg-white border-slate-200 hover:shadow-md"}
                                                    `}
                                                >
                                                    {/* Rank & Medal */}
                                                    <div className="col-span-1 text-base md:text-2xl font-['Bebas_Neue'] text-center text-slate-800">
                                                        {idx + 1}
                                                    </div>
                                                    
                                                    {/* Class Name (Mobile: col-span-5, Desktop: col-span-5) */}
                                                    <div className="col-span-5 md:ml-4 flex-grow truncate">
                                                        <div className={`text-base md:text-lg font-bold ${isTop ? "text-yellow-700" : "text-slate-800"}`}>
                                                            {item.className}
                                                            <span className="ml-1 text-lg md:text-2xl">{medal}</span>
                                                        </div>
                                                        {item.error ? (
                                                            <div className="text-xs text-rose-500 mt-1">
                                                                Error: {item.error.includes("json") ? "Sheet Publish nahi hai ya Access nahi hai." : item.error}
                                                            </div>
                                                        ) : (
                                                            <div className="hidden md:block text-xs text-slate-500">Class Rank</div>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Calculated Unit (Font changed, Centered) */}
                                                    <div className={`col-span-3 text-center md:text-xl font-['Bebas_Neue'] text-indigo-500 tracking-wider`}>
                                                        <span className="md:hidden text-xs text-slate-500 block mb-[-2px]">Unit</span>
                                                        {formattedUnit}
                                                    </div>
                                                    
                                                    {/* Total Amount (Raqam) (Font changed) */}
                                                    <div className={`col-span-3 text-right md:text-2xl font-['Bebas_Neue'] ${isTop ? "text-emerald-700" : "text-indigo-600"} tracking-wide min-w-[50px]`}>
                                                        <span className="md:hidden text-xs text-slate-500 block mb-[-2px]">Amount</span>
                                                        {item.totalAmount.toLocaleString()}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {overallRankData.length === 0 && !isRankLoading && (
                                            <div className="text-center p-4 text-slate-500">Koi Data Available nahi hai ya Sheets Configured nahi hain.</div>
                                        )}
                                    </div>
                                </div>
                            ) : active === "Result" ? (
                                /* --- Result Tab View (Translated to Roman Hindi) --- */
                                <div className="bg-white border rounded-lg p-6 text-center shadow-lg">
                                    <h2 className="text-3xl font-extrabold text-slate-800 mb-4">28/09/2025</h2>
                                    {countdown.expired ? (
                                        <>
                                            <div className="text-3xl font-bold text-emerald-600 mb-4">Results Announce ho gaye hain!</div>
                                            {isResultLoading ? (
                                                <div className="text-sm text-slate-500 animate-pulse">Data Load ho raha hai...</div>
                                            ) : Object.keys(resultData).length > 0 ? (
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                    {Object.keys(resultData).map(className => (
                                                        <div key={className} className="bg-gray-50 border border-gray-200 p-4 rounded-xl shadow-sm">
                                                            <h3 className="text-xl font-bold text-slate-700 mb-3 border-b pb-2">{className} Winners</h3>
                                                            <div className="space-y-2">
                                                                {resultData[className].map((item, index) => (
                                                                    <div key={index} className={`flex items-center p-3 rounded-lg transition-colors ${index === 0 ? "bg-yellow-100 shadow-md" : index === 1 ? "bg-slate-100" : "bg-gray-100"}`}>
                                                                        <span className="text-2xl mr-3">{medalForIndex(index)}</span>
                                                                        <div className="flex-grow text-left">
                                                                            <p className="text-base font-semibold text-slate-800">{item.jamia}</p>
                                                                            <p className="text-xs text-slate-500">{item.ustaz}</p>
                                                                        </div>
                                                                        <span className="font-bold text-lg text-indigo-700">{item.__value.toLocaleString()}</span>
                                                                    </div>
                                                                ))}
                                                                {resultData[className].length === 0 && (
                                                                    <div className="text-sm text-slate-500 p-2">Is Class ke liye koi winner nahi mila.</div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-sm text-slate-500 mt-2">Koi result nahi mila. Kripya thodi der baad dobara check karein.</div>
                                            )}
                                        </>
                                    ) : (
                                        <>
                                            <div className="text-xl font-medium text-slate-600 mb-6">Results 9:30pm Par Announce honge!</div>
                                            <div className="flex justify-center items-end gap-4 md:gap-8 font-bold">
                                                <div className="flex flex-col items-center p-4 bg-sky-100 rounded-xl min-w-[70px] md:min-w-[100px] shadow-lg">
                                                    <span className="text-4xl md:text-5xl text-sky-700">{String(countdown.days).padStart(2, '0')}</span>
                                                    <span className="text-sm md:text-base text-slate-500">Din</span>
                                                </div>
                                                <div className="flex flex-col items-center p-4 bg-sky-100 rounded-xl min-w-[70px] md:min-w-[100px] shadow-lg">
                                                    <span className="text-4xl md:text-5xl text-sky-700">{String(countdown.hours).padStart(2, '0')}</span>
                                                    <span className="text-sm md:text-base text-slate-500">Ghante</span>
                                                </div>
                                                <div className="flex flex-col items-center p-4 bg-sky-100 rounded-xl min-w-[70px] md:min-w-[100px] shadow-lg">
                                                    <span className="text-4xl md:text-5xl text-sky-700">{String(countdown.minutes).padStart(2, '0')}</span>
                                                    <span className="text-sm md:text-base text-slate-500">Minute</span>
                                                </div>
                                                <div className="flex flex-col items-center p-4 bg-sky-100 rounded-xl min-w-[70px] md:min-w-[100px] shadow-lg">
                                                    <span className="text-4xl md:text-5xl text-sky-700">{String(countdown.seconds).padStart(2, '0')}</span>
                                                    <span className="text-sm md:text-base text-slate-500">Second</span>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            ) : (
                                /* --- Live Data Tab View (Translated to Roman Hindi) --- */
                                <div className="bg-white border rounded-lg p-4 shadow-lg relative">
                                    {/* Background Loader for updates (Kept for individual class tabs) */}
                                    {isLoading && isDataLoaded && (
                                        <div className="loading-bg flex justify-center items-start pt-8">
                                            <div className="flex items-center gap-2 text-indigo-600 p-2 bg-indigo-50 rounded-lg shadow-lg">
                                                <div className="loader"></div>
                                                <span className="text-sm font-medium">Data Update ho raha hai...</span>
                                            </div>
                                        </div>
                                    )}
                                    {/* Sheet Configuration Area */}
                                    {(!isValidSheetId(getActiveConfig().id)) && (
                                        <div className="mb-4 p-4 border rounded-xl bg-red-50 border-red-200">
                                            <div className="text-sm font-semibold text-red-700 mb-2">Sheet Configured nahi hai. Live data laane ke liye Google Sheet ka URL ya Sheet ID paste karein.</div>
                                            <form onSubmit={handleSetSheetId} className="flex gap-2">
                                                <input
                                                    value={sheetInput}
                                                    onChange={(e) => setSheetInput(e.target.value)}
                                                    placeholder="Poora Google Sheet URL ya Sheet ID daalein"
                                                    className="flex-1 px-3 py-2 border rounded-lg focus:ring-sky-500 focus:border-sky-500"
                                                />
                                                <button type="submit" className="px-4 py-2 rounded-lg bg-sky-600 text-white font-medium hover:bg-sky-700 transition">Set Sheet</button>
                                            </form>
                                            <div className="text-xs text-slate-500 mt-2">Salaah: Sheet ka Share Link (ya /d/{"{id}"}/ URL) use karein. Agar Permission error aata hai, toh Google Sheets mein File → Publish to web ka prayas karein.</div>
                                            {error && <div className="text-sm text-rose-600 mt-2">Error: {error}</div>}
                                        </div>
                                    )}

                                    {/* General Data Fetch Error */}
                                    {error && isValidSheetId(getActiveConfig().id) && <div className="text-sm text-rose-600 mb-4 p-2 border border-rose-300 bg-rose-50 rounded-lg">Data laane mein Error: {error}</div>}

                                    {/* Items Container */}
                                    <div className={`relative ${showFullScreenLoader ? 'opacity-50 pointer-events-none' : ''}`}>
                                        
                                        {/* Desktop Table */}
                                        <div className="hidden md:block">
                                            {/* Header row */}
                                            <div className="grid grid-cols-12 items-center px-3 py-2 border-b text-sm font-semibold text-slate-700 bg-slate-50 rounded-t-lg">
                                                <div className="col-span-1">Rank</div>
                                                <div className="col-span-2">{ustazLabel}</div>
                                                <div className="col-span-4 text-center">{jamiaLabel}</div>
                                                <div className="col-span-3 text-right">Raqam</div>
                                                <div className="col-span-2 text-right">Unit</div>
                                            </div>

                                            {/* Items */}
                                            <div className="space-y-1 mt-1">
                                                {data.items.map((it, idx) => {
                                                    const isTop = idx === 0;
                                                    const isSecond = idx === 1;
                                                    const isThird = idx === 2;
                                                    const medal = medalForIndex(idx);
                                                    const highlight = it.__id === highlightKey;

                                                    const styleClass = isTop
                                                        ? "bg-yellow-50 border border-yellow-300 shadow-md"
                                                        : isSecond
                                                        ? "bg-sky-50 border border-sky-300"
                                                        : isThird
                                                        ? "bg-emerald-50 border border-emerald-300"
                                                        : "bg-white border-transparent hover:bg-slate-50";

                                                    return (
                                                        <div key={it.__id} className={`grid grid-cols-12 items-center gap-4 p-3 rounded-lg transition-all duration-600 transform ${styleClass} ${highlight ? "highlight-pulse" : ""}`} style={{ willChange: "transform, box-shadow" }}>
                                                            <div className="col-span-1 flex items-center justify-center font-bold text-base">{idx + 1}</div>

                                                            <div className={`col-span-2 text-left ${isTop || isSecond || isThird ? "text-base font-semibold" : "text-sm font-medium text-slate-600"}`}>
                                                                {active === 'Takhassusat' ? (it.jamia || "-") : (it.ustaz || "-")}
                                                            </div>

                                                            <div className={`col-span-4 text-center ${isTop ? "text-xl font-extrabold text-slate-900" : isSecond ? "text-lg font-bold" : isThird ? "text-lg font-semibold" : "text-base font-medium"}`}>
                                                                <span className="inline-flex items-center gap-2">{medal}<span>{active === 'Takhassusat' ? it.ustaz : it.jamia}</span></span>
                                                            </div>

                                                            <div className={`col-span-3 text-right ${isTop ? "text-emerald-600" : isSecond ? "text-sky-600" : isThird ? "text-yellow-600" : "text-slate-700"} text-xl font-bold`}>
                                                                {it.__value.toLocaleString()}
                                                            </div>

                                                            <div className="col-span-2 text-right text-base font-bold text-indigo-600">{it.unit || "-"}</div>
                                                        </div>
                                                    );
                                                })}

                                                {(!data.items || data.items.length === 0) && (
                                                    <div className="text-sm text-slate-500 p-3 text-center">Koi valid row nahi mili (Confirm karein ki 'Jamia Name' aur 'Raqam' column maujood hain aur 'Raqam' value numeric hain).</div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Mobile List View */}
                                        <div className="md:hidden space-y-3">
                                            {data.items.map((it, idx) => {
                                                const isTop = idx === 0;
                                                const isSecond = idx === 1;
                                                const isThird = idx === 2;
                                                const medal = medalForIndex(idx);
                                                const highlight = it.__id === highlightKey;
                                                const styleClass = isTop
                                                        ? "bg-yellow-50 border border-yellow-300 shadow-md"
                                                        : isSecond
                                                        ? "bg-sky-50 border border-sky-300"
                                                        : isThird
                                                        ? "bg-emerald-50 border border-emerald-300"
                                                        : "bg-white border border-slate-100";
                                                
                                                return (
                                                    <div key={it.__id} className={`p-4 rounded-lg shadow-sm transition-all duration-600 transform ${styleClass} ${highlight ? "highlight-pulse" : ""}`} style={{ willChange: "transform, box-shadow" }}>
                                                        <div className="flex items-center justify-between border-b pb-2 mb-2">
                                                            <div className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                                                <span>{idx + 1}.</span>
                                                                <span className="truncate max-w-[200px]">{active === 'Takhassusat' ? it.ustaz : it.jamia}</span>
                                                                <span>{medal}</span>
                                                            </div>
                                                            <div className={`text-xl font-bold text-right ml-auto min-w-0 break-all ${isTop ? "text-emerald-600" : isSecond ? "text-sky-600" : isThird ? "text-yellow-600" : "text-slate-700"}`}>
                                                                {it.__value.toLocaleString()}
                                                            </div>
                                                        </div>
                                                        <div className="text-sm text-slate-600 flex justify-between">
                                                            <div className="truncate mr-4">
                                                                <span className="font-semibold">{ustazLabel}:</span> 
                                                                <span className="text-slate-700 font-medium">
                                                                    {active === 'Takhassusat' ? (it.jamia || "-") : (it.ustaz || "-")}
                                                                </span>
                                                            </div>
                                                            <div>
                                                                <span className="font-semibold">Unit:</span> <span className={`font-bold text-indigo-600`}>{it.unit || "-"}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}

                                            {(!data.items || data.items.length === 0) && (
                                                <div className="text-sm text-slate-500 p-3 text-center">Koi valid row nahi mili (Confirm karein ki 'Jamia Name' aur 'Raqam' column maujood hain aur 'Raqam' value numeric hain).</div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>

                        <footer className="mt-8 text-xs text-slate-500 text-center">Made with ❤️ — Majlis Talimi Umoor India</footer>
                    </div>
                </div>
            );
        }

        // Render the React component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <React.StrictMode>
                <TelethoneEnhancedLive />
            </React.StrictMode>
        );
    </script>

</body>
</html>



