<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telethone 2025 Live Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bowlby+One+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        /* Custom CSS for top 3 rows highlight animation */
        .highlight-pulse {
            animation: pulse-ring 0.6s cubic-bezier(0, 0, 0.2, 1) forwards;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.4);
            }
            100% {
                transform: scale(1.02);
                box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
            }
        }

        /* Custom CSS for Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Blue 500 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* NEW: Custom CSS for smooth transitions on rank items */
        .rank-item {
            /* Smooth transition for position changes */
            transition: all 0.5s ease-in-out;
            will-change: transform, box-shadow;
        }
        /* Hide loading when data is already present (removed from logic, but keeping style for other tabs) */
        .loading-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.6);
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="root"></div>

    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- Utility Functions for Formatting and Animation ---

        // Formatter for Currency
        const formatCurrency = (amount) => {
            // Round to nearest integer for clean animation and display
            return '₹ ' + new Intl.NumberFormat('en-IN').format(Math.round(amount));
        };

        // Formatter for Unit (Used for individual class units, and Overall Rank)
        const formatUnit = (amount) => {
             if (typeof amount !== 'number' || amount < 0) return "0.0";
             const units = amount / 7000; // Apply the new logic
             return units.toFixed(1); // Show exactly 1 decimal place
        }

        // Formatter for Overall Rank Units (Kept for clarity, but logic is same as formatUnit)
        const formatOverallUnit = (amount) => {
             if (typeof amount !== 'number' || amount < 0) return "0.0";
             const units = amount / 7000;
             return units.toFixed(1); // Show exactly 1 decimal place
        }


        // Component for smooth number animation
        const AnimatedNumber = ({ value, duration = 1500, formatter }) => {
            const [displayValue, setDisplayValue] = useState(value);
            const previousValueRef = useRef(value);

            useEffect(() => {
                let startTimestamp;
                const startValue = previousValueRef.current || 0;
                const endValue = value || 0;
                
                if (endValue === startValue) {
                    setDisplayValue(endValue);
                    return;
                }

                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const elapsed = timestamp - startTimestamp;
                    const progress = Math.min(1, elapsed / duration);
                    const easedProgress = 1 - Math.pow(1 - progress, 3); 
                    const currentValue = startValue + (endValue - startValue) * easedProgress;
                    setDisplayValue(currentValue);

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        setDisplayValue(endValue); 
                    }
                };

                const animationFrameId = requestAnimationFrame(step);

                return () => {
                    cancelAnimationFrame(animationFrameId);
                    previousValueRef.current = endValue; 
                };
            }, [value, duration]);

            useEffect(() => {
                previousValueRef.current = value;
            }, [value]);


            return <span>{formatter(displayValue)}</span>;
        };
        
        // --- Live Clock Component ---
        const LiveClock = () => {
            const [time, setTime] = useState(new Date());

            useEffect(() => {
                const timerId = setInterval(() => {
                    setTime(new Date());
                }, 1000);

                return () => clearInterval(timerId);
            }, []);

            return (
                <div className="text-sm font-medium text-slate-600 bg-slate-200 px-3 py-1 rounded-lg shadow-inner">
                    {time.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}
                </div>
            );
        };
        
        // --- Google Sheet Configuration and Logic ---
        
        const DEFAULT_SHEET_CONFIGS = {
            "Ibtidaiya": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Ibtidaiya" },
            "Sale Awwal": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sale Awwal" },
            "Sale Duwam": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sale Duwam" },
            "Ula": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Ula" },
            "Saniya": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Saniya" },
            "Salisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Salisa" },
            "Rabia": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Rabia" },
            "Khamisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Khamisa" },
            "Sadisa": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sadisa" },
            "Sabia": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Sabia" },
            "Doratul Hadis": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Daurul Hadis" },
            "Takhassusat": { id: "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg", sheet: "Takhassusat" },
            "Overall Rank": { id: null, sheet: null },
            "Result": { id: null, sheet: null },
            "Region Competition": { id: null, sheet: null }
        };

        const POLL_INTERVAL_MS = 5000;
        const LOCALSTORAGE_KEY = "telethone_sheet_overrides_enhanced_live";
        const UNIT_DIVISOR = 7000;

        function parseSheetIdFromUrl(input) {
            if (!input) return null;
            input = input.trim();
            const m = input.match(/\/d\/([a-zA-Z0-9-_]{10,})/);
            if (m) return m[1];
            const m2 = input.match(/\/spreadsheets\/d\/e?\/(?:pubhtml\/)?([a-zA-Z0-9-_]{10,})/);
            if (m2) return m2[1];
            if (/^[a-zA-Z0-9-_]{10,}$/.test(input)) return input;
            return null;
        }

        function isValidSheetId(id) {
            return Boolean(id && /^[a-zA-Z0-9-_]{10,}$/.test(id));
        }

        function gvizUrl(sheetId, sheetName) {
            return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        }

        async function fetchSheetData(sheetId, sheetName) {
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const url = gvizUrl(sheetId, sheetName);
                    const res = await fetch(url, { cache: "no-cache" });
                    
                    if (res.status === 429) { 
                        if (attempt < 2) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error("Too many requests to Google Sheets API.");
                    }

                    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
                    const text = await res.text();

                    let jsonText = null;
                    const match = text.match(/setResponse\(([\s\S]*)\);?\s*$/);
                    if (match && match[1]) jsonText = match[1];
                    else {
                        const first = text.indexOf('{');
                        const last = text.lastIndexOf('}');
                        if (first !== -1 && last !== -1 && last > first) jsonText = text.slice(first, last + 1);
                    }

                    if (!jsonText) throw new Error('Could not extract JSON from GViz response; sheet may not be published or allowed.');

                    let data;
                    try {
                        data = JSON.parse(jsonText);
                    } catch (err) {
                        throw new Error('Failed to parse GViz JSON — ' + err.message);
                    }

                    const cols = (data.table.cols || []).map((c, i) => (c.label || c.id || `col${i}`).toString());
                    const rows = (data.table.rows || []).map((r) => r.c.map((cell) => (cell ? (cell.f !== undefined ? cell.f : cell.v) : null)));
                    const items = rows.map((r) => {
                        const obj = {};
                        cols.forEach((k, i) => (obj[k || `col${i}`] = r[i]));
                        return obj;
                    });
                    return { cols, items };

                } catch (error) {
                    if (attempt === 2) throw error;
                    if (error.message.includes("Too many requests")) throw error;
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Failed to fetch sheet data after multiple retries.");
        }

        const RANK_CANDIDATES = ["Rank", "S. R.", "S.R.", "S R", "Sr", "Serial", "S No", "S.No"];
        const USTAZ_CANDIDATES = ["Ustaz Name", "USTAZ NAME", "Ustaz", "Ustad", "Instructor", "Teacher", "Class"];
        const JAMIA_CANDIDATES = ["Jamia Name", "JAMIA NAME", "Jamia", "Jamiah"];
        const RAQAM_CANDIDATES = ["Raqam", "RAQAM", "Amount", "Value", "रकम", "राशि"];
        const UNIT_CANDIDATES = ["Unit", "UNIT", "Units"];
        const REGION_CANDIDATES = ["Region", "REGION", "Zone"];

        function findColumnByCandidates(cols, candidates) {
            const lower = cols.map((c) => (c || "").toLowerCase().trim());
            for (let cand of candidates) {
                const target = cand.toLowerCase().trim();
                const idx = lower.findIndex((c) => c === target);
                if (idx >= 0) return cols[idx];
            }
            for (let cand of candidates) {
                const token = cand.toLowerCase().trim();
                const idx = lower.findIndex((c) => c.includes(token));
                if (idx >= 0) return cols[idx];
            }
            return null;
        }

        function medalForIndex(i) {
            if (i === 0) return "🥇";
            if (i === 1) return "🥈";
            if (i === 2) return "🥉";
            return "";
        }
        
        function calculateTimeRemaining(targetDate) {
            const now = new Date();
            const difference = targetDate - now;

            if (difference <= 0) {
                return { days: 0, hours: 0, minutes: 0, seconds: 0, expired: true };
            }

            const seconds = Math.floor((difference / 1000) % 60);
            const minutes = Math.floor((difference / 1000 / 60) % 60);
            const hours = Math.floor((difference / (1000 * 60 * 60)) % 24);
            const days = Math.floor(difference / (1000 * 60 * 60 * 24));
            
            return { days, hours, minutes, seconds, expired: false }; 
        }
        
        function parseNumericValue(value, isInteger = false) {
            if (value === null || value === undefined || String(value).trim() === "") {
                return NaN;
            }
            const cleaned = String(value).replace(/[^0-9.-]+/g, "");
            const n = Number(cleaned);
            
            if (Number.isNaN(n)) return NaN;
            
            return isInteger ? Math.round(n) : n;
        }
        
        // --- Region Competition Component ---
        const RegionCompetitionView = ({ regionData, isLoading, error }) => {
            const getUnit = (regionName) => {
                 if (!regionName) return 0;
                 const regionNames = Object.keys(regionData);
                 const actualRegionName = regionNames.find(name => name.toLowerCase() === regionName.toLowerCase());
                 return regionData[actualRegionName]?.totalUnit || 0;
            };

            const matchups = [
                { id: 1, teamA: 'Ajmer', teamB: 'Dehli' },
                { id: 2, teamA: 'Mumbai', teamB: 'HYDERABAD & BENGALORE' },
                { id: 3, teamA: 'Kolkata', teamB: 'HYDERABAD' }
            ];

            const calculateScore = (teamName) => {
                if (teamName === 'HYDERABAD & BENGALORE') {
                    return getUnit('HYDERABAD') + getUnit('BENGALORE');
                }
                return getUnit(teamName);
            };
            
            // Initial loader, only shown when no data is present yet
            if (isLoading && Object.keys(regionData).length === 0) {
                 return (
                    <div className="flex justify-center items-center p-10">
                        <div className="loader w-10 h-10 border-t-sky-500 border-4"></div>
                        <span className="ml-4 text-slate-500">Region data load ho raha hai...</span>
                    </div>
                );
            }

            if (error) {
                return <div className="text-center p-4 text-rose-600">{error}</div>;
            }
            
            // Empty state if loading is finished and still no data
            if (Object.keys(regionData).length === 0 && !isLoading) {
                 return <div className="text-center p-10 text-slate-500">Koi region data nahi mila. Sheets mein 'Region' column check karein.</div>;
            }

            // Main view, which is always rendered if data exists, even during updates
            return (
                <div className="bg-white border rounded-lg p-4 shadow-lg relative">
                    {/* Background loader for updates has been removed */}

                    <h2 className="text-2xl md:text-3xl font-bold text-slate-800 mb-6 text-center">Region Competition Scoreboard</h2>
                    <div className="space-y-6">
                        {matchups.map(match => {
                            const scoreA = calculateScore(match.teamA);
                            const scoreB = calculateScore(match.teamB);
                            const winner = scoreA > scoreB ? 'A' : (scoreB > scoreA ? 'B' : 'None');

                            return (
                                <div key={match.id} className="bg-slate-50 border border-slate-200 p-3 md:p-4 rounded-2xl shadow-md transform hover:scale-105 transition-transform duration-300">
                                    {/* Mobile View: hidden on md and up */}
                                    <div className="md:hidden">
                                        <div className={`flex justify-between items-center p-2 rounded-lg mb-2 ${winner === 'A' ? 'bg-green-50' : ''}`}>
                                            <span className={`text-lg font-['Bowlby_One_SC'] uppercase ${winner === 'A' ? 'text-green-600' : 'text-slate-700'}`}>{match.teamA}</span>
                                            <span className={`text-2xl font-['Bebas_Neue'] tracking-wider ${winner === 'A' ? 'text-green-500' : 'text-slate-500'}`}>
                                                <AnimatedNumber value={scoreA} formatter={(val) => val.toFixed(1)} />
                                            </span>
                                        </div>
                                        <div className="text-center text-slate-400 font-bold my-1 text-xl">VS</div>
                                        <div className={`flex justify-between items-center p-2 rounded-lg ${winner === 'B' ? 'bg-green-50' : ''}`}>
                                            <span className={`text-lg font-['Bowlby_One_SC'] uppercase ${winner === 'B' ? 'text-green-600' : 'text-slate-700'}`}>{match.teamB}</span>
                                            <span className={`text-2xl font-['Bebas_Neue'] tracking-wider ${winner === 'B' ? 'text-green-500' : 'text-slate-500'}`}>
                                                <AnimatedNumber value={scoreB} formatter={(val) => val.toFixed(1)} />
                                            </span>
                                        </div>
                                    </div>
                                    
                                    {/* Desktop View: hidden on small screens */}
                                    <div className="hidden md:flex justify-around items-center text-center">
                                        {/* Team A */}
                                        <div className={`flex-1 flex flex-col items-center p-2 rounded-lg ${winner === 'A' ? 'font-extrabold' : ''}`}>
                                            <div className={`text-xl md:text-2xl font-['Bowlby_One_SC'] uppercase ${winner === 'A' ? 'text-green-600' : 'text-slate-700'}`}>{match.teamA}</div>
                                            <div className="text-xs text-slate-500">Region</div>
                                        </div>
                                        
                                        {/* Scores */}
                                        <div className="flex items-center">
                                             <div className={`text-3xl md:text-5xl font-['Bebas_Neue'] p-2 rounded-lg tracking-wider ${winner === 'A' ? 'text-green-500' : 'text-slate-500'}`}>
                                                <AnimatedNumber value={scoreA} formatter={(val) => val.toFixed(1)} />
                                             </div>
                                             <div className="text-2xl md:text-4xl font-extrabold text-slate-400 mx-4">VS</div>
                                             <div className={`text-3xl md:text-5xl font-['Bebas_Neue'] p-2 rounded-lg tracking-wider ${winner === 'B' ? 'text-green-500' : 'text-slate-500'}`}>
                                                 <AnimatedNumber value={scoreB} formatter={(val) => val.toFixed(1)} />
                                             </div>
                                        </div>

                                        {/* Team B */}
                                        <div className={`flex-1 flex flex-col items-center p-2 rounded-lg ${winner === 'B' ? 'font-extrabold' : ''}`}>
                                             <div className={`text-xl md:text-2xl font-['Bowlby_One_SC'] uppercase ${winner === 'B' ? 'text-green-600' : 'text-slate-700'}`}>{match.teamB}</div>
                                            <div className="text-xs text-slate-500">Region</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        function TelethoneEnhancedLive() {
            const options = Object.keys(DEFAULT_SHEET_CONFIGS);
            const [active, setActive] = useState("Ibtidaiya"); 

            const [overrides, setOverrides] = useState(() => {
                try {
                    const raw = localStorage.getItem(LOCALSTORAGE_KEY);
                    if (raw) return JSON.parse(raw);
                } catch (e) {}
                const out = {};
                for (let k of Object.keys(DEFAULT_SHEET_CONFIGS)) if (DEFAULT_SHEET_CONFIGS[k].id) out[k] = DEFAULT_SHEET_CONFIGS[k].id;
                return out;
            });

            useEffect(() => {
                try {
                    localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(overrides));
                } catch (e) {}
            }, [overrides]);

            const [data, setData] = useState({ items: [] });
            const [isLoading, setLoading] = useState(true); 
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [error, setError] = useState(null);
            const [sheetInput, setSheetInput] = useState("");
            const [highlightKey, setHighlightKey] = useState(null);
            const pollRef = useRef(null);
            
            const targetDate = new Date('October 03, 2025 22:00:00 GMT+0530'); 
            const [countdown, setCountdown] = useState(calculateTimeRemaining(targetDate));
            const [resultData, setResultData] = useState({});
            const [isResultLoading, setResultLoading] = useState(false);
            const [resultError, setResultError] = useState(null);

            const [overallRankData, setOverallRankData] = useState([]);
            const [overallTotalAmount, setOverallTotalAmount] = useState(0); 
            const [overallTotalUnit, setOverallTotalUnit] = useState(0);
            
            const [isRankLoading, setRankLoading] = useState(true);
            const [isRankDataLoaded, setIsRankDataLoaded] = useState(false);
            const [rankError, setRankError] = useState(null);
            
            // Region Competition States
            const [regionData, setRegionData] = useState({});
            const [isRegionLoading, setRegionLoading] = useState(true);
            const [regionError, setRegionError] = useState(null);

            function getActiveConfig() {
                const cfg = DEFAULT_SHEET_CONFIGS[active] || { id: "", sheet: "Sheet1" };
                const id = overrides[active] ?? cfg.id ?? "";
                return { id, sheet: cfg.sheet || "Sheet1" };
            }

            async function loadActiveSheet() {
                const { id, sheet } = getActiveConfig();
                
                if (!isValidSheetId(id)) {
                    setData({ items: [] });
                    setError(null);
                    setLoading(false);
                    return;
                }

                if (!isDataLoaded) setLoading(true); 
                setError(null);
                try {
                    const { cols, items: rows } = await fetchSheetData(id, sheet);
                    const rankCol = findColumnByCandidates(cols, RANK_CANDIDATES);
                    const ustazCol = findColumnByCandidates(cols, USTAZ_CANDIDATES);
                    const jamiaCol = findColumnByCandidates(cols, JAMIA_CANDIDATES);
                    const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);

                    if (!jamiaCol || !raqamCol) {
                        setError("Sheet mein 'Jamia Name' aur 'Raqam' ke headers hone chahiye.");
                        setData({ items: [] });
                        setLoading(false);
                        setIsDataLoaded(true);
                        return;
                    }

                    const parsed = rows
                        .map((r, idx) => {
                            const n = parseNumericValue(r[raqamCol]);
                            return { 
                                __id: idx, 
                                rank: String(r[rankCol] || "").trim(), 
                                ustaz: String(r[ustazCol] || "").trim(), 
                                jamia: String(r[jamiaCol] || "").trim(), 
                                unit: formatUnit(n),
                                raqamRaw: r[raqamCol], 
                                __value: n
                            };
                        })
                        .filter((x) => x.jamia !== "" && !Number.isNaN(x.__value));

                    parsed.sort((a, b) => b.__value - a.__value);
                    
                    const newTopId = parsed.length ? parsed[0].__id : null;
                    if (newTopId !== null && newTopId !== highlightKey) {
                        setHighlightKey(newTopId);
                        setTimeout(() => setHighlightKey(null), 1200);
                    }

                    setData({ items: parsed });
                } catch (err) {
                    console.error(err);
                    setError(err.message || String(err));
                    if (!isDataLoaded) setData({ items: [] });
                } finally {
                    setLoading(false);
                    setIsDataLoaded(true);
                }
            }
            
            async function loadOverallRank() {
                if (!isRankDataLoaded) setRankLoading(true);
                setRankError(null);
                const sheetOptions = options.filter(key => DEFAULT_SHEET_CONFIGS[key].id);
                
                const fetchPromises = sheetOptions.map(async (opt) => {
                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                    const id = overrides[opt] ?? cfg.id;
                    if (!isValidSheetId(id)) return { className: opt, totalAmount: 0, totalUnit: 0, error: "Not Configured" };

                    try {
                        const { cols, items: rows } = await fetchSheetData(id, cfg.sheet);
                        const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);
                        if (!raqamCol) return { className: opt, totalAmount: 0, totalUnit: 0, error: "Missing Raqam Column" };
                        
                        let totalAmount = 0;
                        rows.forEach((r) => {
                            const n = parseNumericValue(r[raqamCol]);
                            totalAmount += Number.isNaN(n) ? 0 : n;
                        });
                        
                        return { className: opt, totalAmount, totalUnit: totalAmount / UNIT_DIVISOR, error: null };
                    } catch (err) {
                        return { className: opt, totalAmount: 0, totalUnit: 0, error: err.message };
                    }
                });

                try {
                    const results = await Promise.all(fetchPromises);
                    const validResults = results.filter(r => r.totalAmount > 0 || (r.error && r.error.includes("Missing Raqam Column")));
                    
                    const grandTotalAmount = results.reduce((sum, r) => sum + r.totalAmount, 0);
                    setOverallTotalAmount(grandTotalAmount);
                    setOverallTotalUnit(grandTotalAmount / UNIT_DIVISOR);
                    
                    validResults.sort((a, b) => b.totalAmount - a.totalAmount);

                    setOverallRankData(validResults);
                } catch (e) {
                    setRankError("Sabhi rank data ko process nahi kiya ja saka.");
                } finally {
                     setRankLoading(false);
                     setIsRankDataLoaded(true);
                }
            }

            async function loadAllResults() {
                setResultLoading(true);
                setResultError(null);
                const sheetOptions = options.filter(key => DEFAULT_SHEET_CONFIGS[key].id);

                const fetchPromises = sheetOptions.map(async (opt) => {
                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                    const id = overrides[opt] ?? cfg.id;
                    if (!isValidSheetId(id)) return { className: opt, winners: [], error: "Not Configured" };

                    try {
                        const { cols, items: rows } = await fetchSheetData(id, cfg.sheet);
                        const jamiaCol = findColumnByCandidates(cols, JAMIA_CANDIDATES);
                        const ustazCol = findColumnByCandidates(cols, USTAZ_CANDIDATES);
                        const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);
                        if (!jamiaCol || !raqamCol) return { className: opt, winners: [], error: "Missing Columns" };

                        const parsed = rows
                            .map((r, idx) => ({ 
                                __id: idx, 
                                ustaz: String(r[ustazCol] || "").trim(), 
                                jamia: String(r[jamiaCol] || "").trim(), 
                                __value: parseNumericValue(r[raqamCol]) 
                            }))
                            .filter(x => x.jamia !== "" && !Number.isNaN(x.__value));
                        parsed.sort((a, b) => b.__value - a.__value);
                        return { className: opt, winners: parsed.slice(0, 3) };
                    } catch (err) {
                        return { className: opt, winners: [], error: err.message };
                    }
                });

                try {
                    const results = await Promise.all(fetchPromises);
                    const winnersMap = {};
                    results.forEach(r => {
                        if (r.winners.length > 0) winnersMap[r.className] = r.winners;
                        if (r.error?.includes("Too many requests")) setResultError(r.error);
                    });
                    setResultData(winnersMap);
                } catch (e) {
                    setResultError("Sabhi results data ko process nahi kiya ja saka.");
                } finally {
                    setResultLoading(false);
                }
            }
            
            async function loadRegionData() {
                setRegionLoading(true); // Always set loading to true when starting a fetch
                setRegionError(null);
                
                const sheetOptions = options.filter(key => DEFAULT_SHEET_CONFIGS[key].id);
                const regionTotals = {};

                const fetchPromises = sheetOptions.map(async (opt) => {
                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                    const id = overrides[opt] ?? cfg.id;
                    if (!isValidSheetId(id)) return;

                    try {
                        const { cols, items: rows } = await fetchSheetData(id, cfg.sheet);
                        const raqamCol = findColumnByCandidates(cols, RAQAM_CANDIDATES);
                        const regionCol = findColumnByCandidates(cols, REGION_CANDIDATES);

                        if (!raqamCol || !regionCol) {
                            console.warn(`Sheet "${opt}" is missing 'Raqam' or 'Region' column.`);
                            return;
                        }
                        
                        rows.forEach((r) => {
                            const region = r[regionCol] ? String(r[regionCol]).trim() : null;
                            const n = parseNumericValue(r[raqamCol]);
                            if (region && !Number.isNaN(n)) {
                                if (!regionTotals[region]) regionTotals[region] = 0;
                                regionTotals[region] += n;
                            }
                        });
                    } catch (err) {
                        console.error(`Error fetching region data for ${opt}:`, err);
                    }
                });

                try {
                    await Promise.all(fetchPromises);
                    const finalRegionData = {};
                    for (const region in regionTotals) {
                        finalRegionData[region] = {
                            totalAmount: regionTotals[region],
                            totalUnit: regionTotals[region] / UNIT_DIVISOR
                        };
                    }
                    setRegionData(finalRegionData);
                } catch (e) {
                    setRegionError("Sabhi region data ko process nahi kiya ja saka.");
                } finally {
                    setRegionLoading(false);
                }
            }

            useEffect(() => {
                const actionMap = {
                    "Result": () => {
                        if (countdown.expired) loadAllResults();
                        const timer = setInterval(() => setCountdown(calculateTimeRemaining(targetDate)), 1000);
                        return () => clearInterval(timer);
                    },
                    "Overall Rank": loadOverallRank,
                    "Region Competition": loadRegionData,
                    "Default": loadActiveSheet,
                };
                
                const currentAction = actionMap[active] || actionMap["Default"];
                
                if (pollRef.current) clearInterval(pollRef.current);
                const { id } = getActiveConfig();

                if (active !== "Result" && active !== "Overall Rank" && active !== "Region Competition" && !isValidSheetId(id)) {
                     setData({ items: [] });
                     setError(null);
                     setLoading(false);
                     setIsDataLoaded(true);
                } else {
                    currentAction();
                    if (active !== "Result") {
                        pollRef.current = setInterval(currentAction, POLL_INTERVAL_MS);
                    }
                }
                
                return () => clearInterval(pollRef.current);
            }, [active, overrides, countdown.expired]);

            function handleSetSheetId(e) {
                e.preventDefault();
                const possible = parseSheetIdFromUrl(sheetInput);
                if (!possible) {
                    setError("Invalid Sheet URL/ID.");
                    return;
                }
                setOverrides((prev) => ({ ...prev, [active]: possible }));
                setSheetInput("");
                setError(null);
            }
            
            const ustazLabel = active === 'Takhassusat' ? 'Jamia Name' : 'Ustaz Name';
            const jamiaLabel = active === 'Takhassusat' ? 'Class' : 'Jamia Name';

            const showFullScreenLoader = (active !== "Overall Rank" && active !== "Region Competition" && isLoading && !isDataLoaded) || 
                                         (active === "Overall Rank" && isRankLoading && !isRankDataLoaded) ||
                                         (active === "Region Competition" && isRegionLoading && Object.keys(regionData).length === 0);

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="max-w-7xl mx-auto p-4 sm:p-6">
                        <header className="mb-6 text-center">
                            <h1 className="text-6xl sm:text-7xl font-['Bebas_Neue'] bg-clip-text text-transparent bg-gradient-to-r from-sky-500 to-indigo-600">
                                TELETHON 2025
                            </h1>
                            <p className="text-sm text-slate-500 mt-1">Jamia-tul-Madina India Class/Jamia Wise Positions</p>
                        </header>

                        <nav className="mb-4">
                            <div className="hidden md:flex flex-wrap gap-2 justify-center">
                                {options.map((opt) => {
                                    const cfg = DEFAULT_SHEET_CONFIGS[opt];
                                    const id = overrides[opt] ?? cfg.id ?? "";
                                    const valid = opt.includes("Rank") || opt.includes("Result") || opt.includes("Competition") || isValidSheetId(id); 
                                    return (
                                        <button
                                            key={opt}
                                            onClick={() => setActive(opt)}
                                            className={`px-3 py-2 rounded-2xl font-medium text-sm shadow-sm focus:outline-none transition-transform transform hover:-translate-y-0.5 ${ active === opt ? "bg-sky-600 text-white shadow-lg" : "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50" }`}
                                            title={!valid ? "Not configured" : ""}
                                        >
                                            <span className="inline-flex items-center gap-2">
                                                {!opt.includes("Rank") && !opt.includes("Result") && !opt.includes("Competition") && <span className={`w-2 h-2 rounded-full ${valid ? "bg-emerald-400" : "bg-rose-400"}`} />}
                                                <span>{opt}</span>
                                            </span>
                                        </button>
                                    );
                                })}
                            </div>

                            <div className="md:hidden">
                                <select value={active} onChange={(e) => setActive(e.target.value)} className="block w-full px-3 py-2 rounded-lg bg-white border border-slate-300 text-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 shadow-sm">
                                    {options.map((opt) => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>
                        </nav>
                        
                        <div className="flex flex-col items-center justify-center p-3 bg-indigo-50 rounded-xl shadow-md mb-4 border border-indigo-200">
                            <h2 className="text-2xl font-['Bowlby_One_SC'] text-indigo-900 text-center uppercase">{active}</h2>
                        </div>

                        <main className="relative">
                            {showFullScreenLoader && (
                                <div className="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex justify-center items-center rounded-lg shadow-xl">
                                    <div className="text-xl text-slate-500 flex flex-col items-center p-8 bg-white border rounded-xl shadow-lg">
                                        <div className="loader w-10 h-10 mb-4 border-t-sky-500 border-4"></div>
                                        Loading...
                                    </div>
                                </div>
                            )}

                            {active === "Overall Rank" ? (
                                <div className="bg-white border rounded-lg p-4 shadow-lg relative">
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <h2 className="text-xl md:text-2xl font-bold text-slate-800">All India Classic Rank</h2>
                                        <LiveClock />
                                    </div>
                                    {rankError && <div className="text-sm text-rose-600 mb-4 p-2 border border-rose-300 bg-rose-50 rounded-lg">Error: {rankError}</div>}
                                    <div className="hidden md:grid grid-cols-12 items-center px-3 py-2 border-b text-sm font-semibold text-slate-700 bg-slate-50 rounded-t-lg">
                                        <div className="col-span-1">Rank</div>
                                        <div className="col-span-5">Class Name</div>
                                        <div className="col-span-3 text-center">Calculated Unit</div>
                                        <div className="col-span-3 text-right">Total Amount</div>
                                    </div>
                                    <div className="space-y-3 mt-1">
                                        {overallRankData.map((item, idx) => (
                                            <div key={item.className} className={`rank-item grid grid-cols-12 items-center p-3 md:p-4 rounded-xl shadow-sm border ${idx === 0 ? "bg-yellow-50 border-yellow-400 shadow-lg" : "bg-white border-slate-200 hover:shadow-md"}`}>
                                                <div className="col-span-1 text-base md:text-2xl font-['Bebas_Neue'] text-center text-slate-800">{idx + 1}</div>
                                                <div className="col-span-5 md:ml-4 flex-grow truncate">
                                                    <div className={`text-base md:text-lg font-bold ${idx === 0 ? "text-yellow-700" : "text-slate-800"}`}>
                                                        {item.className}
                                                        <span className="ml-1 text-lg md:text-2xl">{medalForIndex(idx)}</span>
                                                    </div>
                                                    {item.error ? <div className="text-xs text-rose-500 mt-1">Error: {item.error}</div> : <div className="hidden md:block text-xs text-slate-500">Class Rank</div>}
                                                </div>
                                                <div className="col-span-3 text-center md:text-xl font-['Bebas_Neue'] text-indigo-500 tracking-wider">
                                                    <span className="md:hidden text-xs text-slate-500 block mb-[-2px]">Unit</span>
                                                    {formatOverallUnit(item.totalAmount)}
                                                </div>
                                                <div className={`col-span-3 text-right md:text-2xl font-['Bebas_Neue'] ${idx === 0 ? "text-emerald-700" : "text-indigo-600"} tracking-wide min-w-[50px]`}>
                                                    <span className="md:hidden text-xs text-slate-500 block mb-[-2px]">Amount</span>
                                                    {item.totalAmount.toLocaleString()}
                                                </div>
                                            </div>
                                        ))}
                                        {overallRankData.length === 0 && !isRankLoading && <div className="text-center p-4 text-slate-500">No data available.</div>}
                                    </div>
                                </div>
                            ) : active === "Result" ? (
                                <div className="bg-white border rounded-lg p-6 text-center shadow-lg">
                                    <h2 className="text-3xl font-extrabold text-slate-800 mb-4">Special Day Majlis Talimi Umoor</h2>
                                    {countdown.expired ? (
                                        <>
                                            <div className="text-3xl font-bold text-emerald-600 mb-4">Results Announced!</div>
                                            {isResultLoading ? <div className="text-sm text-slate-500 animate-pulse">Loading...</div> : Object.keys(resultData).length > 0 ? (
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                    {Object.keys(resultData).map(className => (
                                                        <div key={className} className="bg-gray-50 border border-gray-200 p-4 rounded-xl shadow-sm">
                                                            <h3 className="text-xl font-bold text-slate-700 mb-3 border-b pb-2">{className} Winners</h3>
                                                            <div className="space-y-2">
                                                                {resultData[className].map((item, index) => (
                                                                    <div key={index} className={`flex items-center p-3 rounded-lg ${index === 0 ? "bg-yellow-100" : "bg-slate-100"}`}>
                                                                        <span className="text-2xl mr-3">{medalForIndex(index)}</span>
                                                                        <div className="flex-grow text-left">
                                                                            <p className="text-base font-semibold text-slate-800">{item.jamia}</p>
                                                                            <p className="text-xs text-slate-500">{item.ustaz}</p>
                                                                        </div>
                                                                        <span className="font-bold text-lg text-indigo-700">{item.__value.toLocaleString()}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : <div className="text-sm text-slate-500 mt-2">No results found.</div>}
                                        </>
                                    ) : (
                                        <>
                                            <div className="text-xl font-medium text-slate-600 mb-6">Results will be announced at 10:00pm!</div>
                                            <div className="flex justify-center items-end gap-4 md:gap-8 font-bold">
                                                {Object.entries({ Days: countdown.days, Hours: countdown.hours, Minutes: countdown.minutes, Seconds: countdown.seconds }).map(([label, value]) => (
                                                    <div key={label} className="flex flex-col items-center p-4 bg-sky-100 rounded-xl min-w-[70px] shadow-lg">
                                                        <span className="text-4xl md:text-5xl text-sky-700">{String(value).padStart(2, '0')}</span>
                                                        <span className="text-sm md:text-base text-slate-500">{label}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </>
                                    )}
                                </div>
                            ) : active === "Region Competition" ? (
                                <RegionCompetitionView regionData={regionData} isLoading={isRegionLoading} error={regionError} />
                            ) : (
                                <div className="bg-white border rounded-lg p-4 shadow-lg relative">
                                    {/* The background "Updating..." indicator that appeared on data refresh has been removed */}
                                    {!isValidSheetId(getActiveConfig().id) && (
                                        <div className="mb-4 p-4 border rounded-xl bg-red-50 border-red-200">
                                            <div className="text-sm font-semibold text-red-700 mb-2">Sheet not configured. Paste Google Sheet URL or ID.</div>
                                            <form onSubmit={handleSetSheetId} className="flex gap-2">
                                                <input value={sheetInput} onChange={(e) => setSheetInput(e.target.value)} placeholder="Google Sheet URL or Sheet ID" className="flex-1 px-3 py-2 border rounded-lg focus:ring-sky-500"/>
                                                <button type="submit" className="px-4 py-2 rounded-lg bg-sky-600 text-white font-medium">Set Sheet</button>
                                            </form>
                                            {error && <div className="text-sm text-rose-600 mt-2">Error: {error}</div>}
                                        </div>
                                    )}
                                    {error && isValidSheetId(getActiveConfig().id) && <div className="text-sm text-rose-600 mb-4 p-2 border border-rose-300 bg-rose-50 rounded-lg">Error: {error}</div>}
                                    <div className={`relative ${showFullScreenLoader ? 'opacity-50 pointer-events-none' : ''}`}>
                                        <div className="hidden md:block">
                                            <div className="grid grid-cols-12 items-center px-3 py-2 border-b text-sm font-semibold text-slate-700 bg-slate-50 rounded-t-lg">
                                                <div className="col-span-1">Rank</div>
                                                <div className="col-span-2">{ustazLabel}</div>
                                                <div className="col-span-4 text-center">{jamiaLabel}</div>
                                                <div className="col-span-3 text-right">Raqam</div>
                                                <div className="col-span-2 text-right">Unit</div>
                                            </div>
                                            <div className="space-y-1 mt-1">
                                                {data.items.map((it, idx) => {
                                                    const styleClass = idx === 0 ? "bg-yellow-50 border-yellow-300 shadow-md" : idx === 1 ? "bg-sky-50 border-sky-300" : idx === 2 ? "bg-emerald-50 border-emerald-300" : "bg-white border-transparent hover:bg-slate-50";
                                                    return (
                                                        <div key={it.__id} className={`grid grid-cols-12 items-center gap-4 p-3 rounded-lg transition-all duration-600 ${styleClass} ${it.__id === highlightKey ? "highlight-pulse" : ""}`}>
                                                            <div className="col-span-1 font-bold text-base">{idx + 1}</div>
                                                            <div className="col-span-2 text-left text-sm font-medium">{active === 'Takhassusat' ? (it.jamia || "-") : (it.ustaz || "-")}</div>
                                                            <div className={`col-span-4 text-center font-bold ${idx === 0 ? 'text-xl' : 'text-lg'}`}><span className="inline-flex items-center gap-2">{medalForIndex(idx)}<span>{active === 'Takhassusat' ? it.ustaz : it.jamia}</span></span></div>
                                                            <div className="col-span-3 text-right text-xl font-bold">{it.__value.toLocaleString()}</div>
                                                            <div className="col-span-2 text-right text-lg font-['Bebas_Neue'] text-indigo-600 tracking-wider">{it.unit || "-"}</div>
                                                        </div>
                                                    );
                                                })}
                                                {data.items.length === 0 && <div className="text-sm text-slate-500 p-3 text-center">No valid rows found.</div>}
                                            </div>
                                        </div>
                                        <div className="md:hidden space-y-3">
                                            {data.items.map((it, idx) => (
                                                <div key={it.__id} className={`p-4 rounded-lg shadow-sm ${idx === 0 ? "bg-yellow-50 border-yellow-300" : "bg-white border-slate-100"} ${it.__id === highlightKey ? "highlight-pulse" : ""}`}>
                                                    <div className="flex items-center justify-between border-b pb-2 mb-2">
                                                        <div className="text-xl font-bold text-slate-800 flex items-center gap-2"><span>{idx + 1}.</span><span className="truncate max-w-[200px]">{active === 'Takhassusat' ? it.ustaz : it.jamia}</span><span>{medalForIndex(idx)}</span></div>
                                                        <div className="text-xl font-bold text-right">{it.__value.toLocaleString()}</div>
                                                    </div>
                                                    <div className="text-sm text-slate-600 flex justify-between">
                                                        <div className="truncate mr-4"><span className="font-semibold">{ustazLabel}:</span> {active === 'Takhassusat' ? (it.jamia || "-") : (it.ustaz || "-")}</div>
                                                        <div><span className="font-semibold">Unit:</span> <span className="font-['Bebas_Neue'] font-bold text-lg text-indigo-600">{it.unit || "-"}</span></div>
                                                    </div>
                                                </div>
                                            ))}
                                            {data.items.length === 0 && <div className="text-sm text-slate-500 p-3 text-center">No valid rows found.</div>}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>

                        <footer className="mt-8 text-xs text-slate-500 text-center">Made with ❤️ — Majlis Talimi Umoor India</footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><TelethoneEnhancedLive /></React.StrictMode>);
    </script>

</body>
</html>



